<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回忆良药铺</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CryptoJS库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="css/style.css">
    
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">回忆良药铺</span>
            
            <!-- 添加搜索框 -->
            <div class="d-flex align-items-center me-3">
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control" placeholder="输入地址进行搜索..." style="max-width: 250px;">
                    <button class="btn btn-outline-primary" type="button" onclick="searchLocation()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="清除搜索标记">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- 在导航栏搜索框后添加专辑选择器 -->
            <div class="btn-group me-2">
                <button id="mapSourceBtn" type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-images"></i> 专辑
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item album-option active" href="#" data-source=0>敬请期待</a></li>
                    <li><a class="dropdown-item album-option" href="#" data-source=1>敬请期待</a></li>
                    <li><a class="dropdown-item album-option" href="#" data-source=2>敬请期待</a></li>
                </ul>
            </div>
            <div class="d-flex">
                <!-- 地图源切换按钮 -->
                <div class="btn-group me-2" role="group">
                    <button id="mapSourceBtn" type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-layer-group"></i> 地图样式
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item map-source-option active" href="#" data-source=0>标准地图</a></li>
                        <li><a class="dropdown-item map-source-option" href="#" data-source=1>卫星影像</a></li>
                        <li><a class="dropdown-item map-source-option" href="#" data-source=2>卫星影像（含路网）</a></li>
                    </ul>
                </div>
                
                <button class="btn btn-outline-info" onclick="toggleFullScreen()">
                    <i class="fas fa-expand"></i> 全屏
                </button>
            </div>
        </div>
    </nav>
    
    <!-- 数据更新提示弹窗 -->
    <div id="updateNotification" class="update-notification">
        <div class="update-notification-content">
            <i class="fas fa-info-circle"></i>
            <span id="updateMessage">数据更新至 <span id="updateTime"></span></span>
        </div>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>
    
    <!-- 照片查看器 -->
    <div class="photo-viewer" id="photoViewer">
        <div class="close-btn" id="cbt" onclick="closePhotoViewer()">
            <i class="fas fa-times"></i>
        </div>
        
        <div class="photo-container">
            <div class="photo-display">
                <img class="main-photo" id="mainPhoto" src="" alt="Photo">
            </div>
        </div>
        
        <div class="photo-controls">
            <div class="nav-btn prev-btn" onclick="navigatePhoto(-1)">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="nav-btn next-btn" onclick="navigatePhoto(1)">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <div class="photo-toolbar">
            <button class="toolbar-btn" onclick="toggleDetails()">
                <i class="fas fa-info-circle"></i> 详情
            </button>
            <button class="toolbar-btn" onclick="downloadCurrentPhoto()">
                <i class="fas fa-download"></i> 下载
            </button>
        </div>
        
        <div class="photo-preview-container" id="ppc">
            <button class="preview-nav-btn preview-prev-btn" onclick="scrollPreviews(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="photo-preview" id="photoPreview">
                <!-- 预览小图将通过JS动态添加 -->
            </div>
            
            <button class="preview-nav-btn preview-next-btn" onclick="scrollPreviews(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="photo-details" id="photoDetails">
            <h3>照片详情</h3>
            <div class="detail-item">
                <label>位置</label>
                <div class="value" id="detailLocation"></div>
            </div>
            <div class="detail-item">
                <label>尺寸</label>
                <div class="value" id="detailDimensions"></div>
            </div>
            <div class="detail-item">
                <label>文件名称</label>
                <div class="value" id="detailFilename"></div>
            </div>
            <div class="detail-item">
                <label>拍摄时间</label>
                <div class="value" id="shotTime"></div>
            </div>
            
            <div class="note-section">
                <h4>备注</h4>
                <div class="note-content" id="noteContent">
                    <!-- 备注内容将通过JS动态添加 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 密码输入模态框 -->
    <div class="modal fade" id="passwordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">需要密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>此照片地图数据已加密，请输入密码查看</p>
                    <div class="mb-3">
                        <label for="viewerPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="viewerPassword" placeholder="输入密码">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="decryptData()">确认</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 必要的JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- 照片数据 -->
    <!-- <script src="photo_data.js"></script> -->
    <script src="https://mapphoto-1317341370.cos.ap-beijing.myqcloud.com/photo_data.js"></script>
    
    <script>
        // 全局变量
        let map;
        let photoMarkers = [];
        let photoClusters = {};
        let currentViewerMarkers = [];
        let currentPhotoIndex = 0;
        let searchMarker = null;
        let amapKey = 'fe4d710bb0b7ecb71c69ca60b9963e6d';
        let isDetailsOpen = false;
        let decryptedData = null;
        let passwordModal = null;
        let isModalOpen = false;
        let previewScrollPosition = 0;
        const PREVIEWS_VISIBLE = 8; // 可见预览图数量
        const SERVER_HOST = 'https://mapphoto-1317341370.cos.ap-beijing.myqcloud.com/';
        // const SERVER_HOST = './';

        let currentPhoto = null;
        let pendingPhotos = [];
        let contextMenuLocation = null;
        let isSidebarOpen = false;

        let mapLoader = {};

        // 初始化地图
        function initMap() {
            // 创建地图实例，设置中心点和缩放级别
            map = L.map('map').setView([35.8617, 104.1954], 5); // 中国中心点
            
            // 使用高德地图瓦片
            standard = L.tileLayer('https://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=7', {
                attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
                maxZoom: 19,
                subdomains: ['1', '2', '3', '4']
            });

            // 卫星地图
            satellite = L.tileLayer('https://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=6', {
                attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
                maxZoom: 19,
                subdomains: ['1', '2', '3', '4']
            });

            // 卫星地图-路网
            satellite_road = L.tileLayer('https://wprd0{s}.is.autonavi.com/appmaptile?x={x}&y={y}&z={z}&lang=zh_cn&size=1&scl=1&style=8', {
                attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
                maxZoom: 19,
                subdomains: ['1', '2', '3', '4']
            });

            mapLoader['cur'] = -1; // 缺省值
            mapLoader['set'] = [standard, satellite, satellite_road]
            
            // 默认地图
            switchMapSource(mapLoader['cur']);
            
            // 监听搜索框的回车键
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePhotoViewer();
                } else if (e.key === 'ArrowLeft') {
                    navigatePhoto(-1);
                } else if (e.key === 'ArrowRight') {
                    navigatePhoto(1);
                }
            });
            // 加载预置的照片数据
            loadPredefinedPhotos();
        }

        function switchMapSource(switchTo) {
            if (switchTo === -1){
                mapLoader['set'][0].addTo(map);
                mapLoader['cur'] = 0;
                return;
            }

            if (mapLoader['cur'] === switchTo){
                return;
            }

            // 移除当前地图层
            if (switchTo === 0) {
                try{
                    map.removeLayer(mapLoader['set'][2]);
                } catch {}
                map.removeLayer(mapLoader['set'][1]);
                mapLoader['set'][0].addTo(map);
                mapLoader['cur'] = 0;
            } else if(switchTo === 1){
                try{
                    map.removeLayer(mapLoader['set'][2]);
                } catch {}
                try{
                    map.removeLayer(mapLoader['set'][0]);
                    mapLoader['set'][1].addTo(map);
                } catch {}
                mapLoader['cur'] = 1;
            } else{
                try{
                    map.removeLayer(mapLoader['set'][0]);
                    mapLoader['set'][1].addTo(map);
                    mapLoader['set'][2].addTo(map);
                } catch {
                    mapLoader['set'][2].addTo(map);
                }
                mapLoader['cur'] = 2;
            }
            
            // 更新按钮状态
            updateMapSourceButtonState(switchTo);

        }

        // 更新地图源按钮状态
        function updateMapSourceButtonState(sourceKey) {
            // 更新下拉菜单选项状态
            document.querySelectorAll('.map-source-option').forEach(option => {
                if (parseInt(option.dataset.source) === sourceKey) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // 更新按钮文本
            // const mapSourceBtn = document.getElementById('mapSourceBtn');
            // mapSourceBtn.innerHTML = `<i class="fas fa-layer-group"></i> ${mapSources[sourceKey].name}`;
        }

        // 初始化地图源切换事件
        function initMapSourceEvents() {
            // 地图源选项点击事件
            document.querySelectorAll('.map-source-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sourceKey = parseInt(this.dataset.source);
                    switchMapSource(sourceKey);
                });
            });
        }

        // 解密函数
        function decryptData() {
            const password = document.getElementById('viewerPassword').value;
            if (!password) {
                alert('请输入密码');
                return;
            }
            
            try {
                // 提取盐、IV和加密数据
                const encryptedData = a.data;
                const salt = CryptoJS.enc.Hex.parse(encryptedData.substring(0, 32));
                const iv = CryptoJS.enc.Hex.parse(encryptedData.substring(32, 64));
                const ciphertext = encryptedData.substring(64);
                
                // 使用PBKDF2派生密钥
                const key = CryptoJS.PBKDF2(password, salt, {
                    keySize: 256/32,
                    iterations: 1000
                });
                
                // 解密数据
                const decrypted = CryptoJS.AES.decrypt(ciphertext, key, {
                    iv: iv,
                    padding: CryptoJS.pad.Pkcs7,
                    mode: CryptoJS.mode.CBC
                });
                
                // 转换为UTF-8字符串
                const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
                
                // 解析JSON数据
                decryptedData = JSON.parse(decryptedStr);
                
                // 关闭模态框
                passwordModal.hide();

                // 手动移除模态框背景（添加这行代码）
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

                // 清空密码字段
                document.getElementById('viewerPassword').value = '';
                
                // 加载照片数据
                loadPredefinedPhotos();
                
                // 显示导出时间
                setTimeout(showUpdateNotification, 500);
            } catch (error) {
                alert('解密失败，密码错误或数据已损坏');
                // 清空密码字段
                document.getElementById('viewerPassword').value = '';
                document.getElementById('viewerPassword').focus();
            }
        }

        // 加载预置的照片数据
        function loadPredefinedPhotos() {
            if (!decryptedData) {
                // 显示密码输入框
                const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
                passwordModal.show();
                return;
            }
            
            // 确保移除所有模态框背景（添加这行代码）
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

            decryptedData.photos.forEach(photo => {
                addPhotoToMap(photo);
            });
            
            // 更新照片聚类
            updatePhotoClusters();

            // 确保地图可以交互（添加这行代码）
            map.getContainer().style.pointerEvents = 'auto';
        }

        // 添加照片到地图
        function addPhotoToMap(photo) {
            // 创建自定义标记
            const marker = L.marker([photo.lat, photo.lng], {
                icon: L.divIcon({
                    className: 'photo-marker fade-in',
                    html: `<img src="${SERVER_HOST}/${photo.thumb}" alt="${photo.filename}">`,
                    iconSize: [photo.thumbWidth, photo.thumbHeight],
                    iconAnchor: [photo.thumbWidth/2, photo.thumbHeight/2]
                })
            });
            
            // 存储照片数据
            marker.photoData = photo;
            
            // 添加点击事件
            marker.on('click', function() {
                showPhotoViewer([marker], 0);
            });
            
            // 添加到地图
            marker.addTo(map);
            photoMarkers.push(marker);
        }

        // 更新照片聚类
        function updatePhotoClusters() {
            // 清空现有聚类
            for (const key in photoClusters) {
                map.removeLayer(photoClusters[key]);
            }
            photoClusters = {};
            
            // 按位置分组照片
            const groupedMarkers = {};
            const clusterDistance = 0.01; // 聚类距离（经纬度）
            
            photoMarkers.forEach(marker => {
                const lat = marker.getLatLng().lat;
                const lng = marker.getLatLng().lng;
                
                // 查找附近的现有聚类
                let foundCluster = false;
                for (const key in groupedMarkers) {
                    const [clusterLat, clusterLng] = key.split(',').map(Number);
                    const distance = Math.sqrt(Math.pow(lat - clusterLat, 2) + Math.pow(lng - clusterLng, 2));
                    
                    if (distance < clusterDistance) {
                        groupedMarkers[key].push(marker);
                        foundCluster = true;
                        break;
                    }
                }
                
                // 如果没有找到附近的聚类，创建新聚类
                if (!foundCluster) {
                    const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
                    groupedMarkers[key] = [marker];
                }
            });
            
            // 为每个组创建聚类标记
            for (const key in groupedMarkers) {
                const markers = groupedMarkers[key];
                
                if (markers.length > 1) {
                    // 创建聚类标记 - 显示叠加的照片
                    const centerLat = markers.reduce((sum, m) => sum + m.getLatLng().lat, 0) / markers.length;
                    const centerLng = markers.reduce((sum, m) => sum + m.getLatLng().lng, 0) / markers.length;
                    
                    // 创建叠加照片的HTML
                    let clusterHtml = '<div class="photo-cluster">';
                    
                    // 最多显示4张照片的叠加
                    const maxPhotosToShow = Math.min(4, markers.length);
                    for (let i = 0; i < maxPhotosToShow; i++) {
                        // 随机旋转角度 (-15° 到 +15°)
                        const rotation = (Math.random() * 30) - 15;
                        
                        // 随机偏移 (-5px 到 +5px)
                        const offsetX = (Math.random() * 10) - 5;
                        const offsetY = (Math.random() * 10) - 5;

                        const thumbWidth = markers[i].photoData.thumbWidth;
                        const thumbHeight = markers[i].photoData.thumbHeight;
                        const aspectRatio = thumbWidth / thumbHeight;
                        // 根据宽高比设置显示尺寸
                        let displayWidth, displayHeight;
                        if (aspectRatio > 1) {
                            // 横版照片
                            displayWidth = i === 0 ? 70 : 60;
                            displayHeight = displayWidth / aspectRatio;
                        } else {
                            // 竖版照片
                            displayHeight = i === 0 ? 70 : 60;
                            displayWidth = displayHeight * aspectRatio;
                        }

                        clusterHtml += `
                            <div class="cluster-photo" style="
                                transform: rotate(${rotation}deg);
                                z-index: ${maxPhotosToShow - i};
                                left: ${offsetX}px;
                                top: ${offsetY}px;
                                width: ${displayWidth}px;
                                height: ${displayHeight}px;
                            ">
                                <img src="${SERVER_HOST}${markers[i].photoData.thumb}" alt="Photo">
                            </div>
                        `;
                    }
                    
                    // 添加照片数量指示器
                    if (markers.length > maxPhotosToShow) {
                        clusterHtml += `<div class="cluster-count">${markers.length}</div>`;
                    }
                    
                    clusterHtml += '</div>';
                    
                    const cluster = L.marker([centerLat, centerLng], {
                        icon: L.divIcon({
                            className: 'fade-in',
                            html: clusterHtml,
                            iconSize: [80, 80],
                            iconAnchor: [40, 40]
                        })
                    });
                    
                    // 添加点击事件
                    cluster.on('click', function() {
                        showPhotoViewer(markers, 0);
                    });
                    
                    // 添加到地图和聚类对象
                    cluster.addTo(map);
                    photoClusters[key] = cluster;
                    
                    // 隐藏单个标记
                    markers.forEach(marker => {
                        map.removeLayer(marker);
                    });
                } else {
                    // 单个照片，确保显示在地图上
                    if (!map.hasLayer(markers[0])) {
                        markers[0].addTo(map);
                    }
                }
            }
        }
        
        // 搜索位置函数
        function searchLocation() {
            const address = document.getElementById('search-input').value.trim();
            if (!address) {
                alert('请输入要搜索的地址');
                return;
            }
            
            // 使用高德地图地理编码API
            const encodedAddress = encodeURIComponent(address);
            const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodedAddress}&output=JSON&key=${amapKey}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location;
                        const [lng, lat] = location.split(',').map(Number);
                        
                        // 移动到搜索到的位置
                        map.setView([lat, lng], 15);
                        
                        // 清除之前的搜索标记
                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }
                        
                        // 添加新标记
                        searchMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'search-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 30px;"></i>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(map);
                        
                        // 添加弹出窗口
                        searchMarker.bindPopup(`
                            <div style="text-align: center;">
                                <strong>${data.geocodes[0].formatted_address}</strong><br>
                                <small>${data.geocodes[0].province} ${data.geocodes[0].city} ${data.geocodes[0].district}</small>
                            </div>
                        `).openPopup();
                    } else {
                        alert('未找到该地址，请尝试更具体的地址描述');
                    }
                })
                .catch(error => {
                    console.error('搜索失败:', error);
                    alert('搜索失败，请检查网络连接或稍后重试');
                });
        }
        
        // 清除搜索标记
        function clearSearch() {
            if (searchMarker) {
                map.removeLayer(searchMarker);
                searchMarker = null;
            }
            document.getElementById('search-input').value = '';
        }
        
        // 显示照片查看器
        function showPhotoViewer(markers, index) {
            currentViewerMarkers = markers;
            currentPhotoIndex = index;
            
            // 隐藏导航栏
            document.querySelector('.navbar').classList.add('navbar-hidden');
            
            // 隐藏地图缩放控件
            const zoomControl = document.querySelector('.leaflet-control-zoom');
            if (zoomControl) {
                zoomControl.classList.add('leaflet-control-zoom-hidden');
            }
                
            // 显示照片查看器
            const photoViewer = document.getElementById('photoViewer');
            photoViewer.classList.add('active');
            
            // 更新照片显示
            updatePhotoDisplay();
            
            // 更新预览小图
            updatePhotoPreviews();
            
            // 关闭详情面板（如果打开）
            closeDetails();
        }
        
        // 更新照片显示
        function updatePhotoDisplay() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const mainPhoto = document.getElementById('mainPhoto');
            
            // 设置照片URL
            mainPhoto.src = SERVER_HOST + marker.photoData.full;
            
            // 更新详情信息
            updatePhotoDetails();
        }
        
        // 更新照片详情
        function updatePhotoDetails() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            
            document.getElementById('detailLocation').textContent = 
                `${marker.photoData.lat.toFixed(6)}, ${marker.photoData.lng.toFixed(6)}`;
            
            document.getElementById('detailDimensions').textContent = 
                `${marker.photoData.width || '未知'} × ${marker.photoData.height || '未知'}`;
            
            document.getElementById('detailFilename').textContent = 
                marker.photoData.filename;
            
            document.getElementById('shotTime').textContent = 
                marker.photoData.shotTime;
                
            // document.getElementById('detailTimestamp').textContent = 
            //     marker.photoData.timestamp;
            
            // 更新备注
            const noteContent = document.getElementById('noteContent');
            if (marker.photoData.note) {
                noteContent.textContent = marker.photoData.note;
            } else {
                noteContent.textContent = '暂无备注';
                noteContent.style.color = '#999';
                noteContent.style.fontStyle = 'italic';
            }
        }
        
        // 更新照片预览
        function updatePhotoPreviews() {
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = '';
            
            if (currentViewerMarkers.length === 0) return;
            
            // 重置滚动位置
            previewScrollPosition = 0;
            
            // 添加所有预览图
            currentViewerMarkers.forEach((marker, i) => {
                const previewItem = document.createElement('div');
                previewItem.className = `preview-item ${i === currentPhotoIndex ? 'active' : ''}`;
                previewItem.dataset.index = i;
                
                const img = document.createElement('img');
                img.src = SERVER_HOST + marker.photoData.thumb;
                img.alt = `预览图 ${i + 1}`;
                
                // 如果照片数量超过可见数量，添加数量指示器
                // if (i === PREVIEWS_VISIBLE - 1 && currentViewerMarkers.length > PREVIEWS_VISIBLE) {
                //     const countIndicator = document.createElement('div');
                //     countIndicator.className = 'photo-count-indicator';
                //     countIndicator.textContent = `+${currentViewerMarkers.length - PREVIEWS_VISIBLE + 1}`;
                //     previewItem.appendChild(countIndicator);
                // }
                
                previewItem.appendChild(img);
                previewItem.addEventListener('click', () => {
                    navigateToPhoto(i);
                });
                
                photoPreview.appendChild(previewItem);
            });
            
            // 添加总照片数量显示
            if (currentViewerMarkers.length > 1) {
                const totalCount = document.createElement('div');
                totalCount.className = 'total-photo-count';
                totalCount.textContent = `${currentPhotoIndex + 1}/${currentViewerMarkers.length}`;
                photoPreview.parentNode.appendChild(totalCount);
            }
            
            // 更新导航按钮状态
            updatePreviewNavButtons();
            
            // 确保当前选中的照片在可视区域内
            ensureActivePreviewVisible();
        }

        // 滚动预览栏
        function scrollPreviews(direction) {
            const photoPreview = document.getElementById('photoPreview');
            const previewItems = photoPreview.querySelectorAll('.preview-item');
            
            if (previewItems.length <= PREVIEWS_VISIBLE) return;
            
            // 计算新的滚动位置
            const maxScroll = previewItems.length - PREVIEWS_VISIBLE;
            previewScrollPosition = Math.max(0, Math.min(maxScroll, previewScrollPosition + direction));
            
            // 计算滚动距离
            const itemWidth = previewItems[0].offsetWidth + parseInt(getComputedStyle(photoPreview).gap);
            const scrollDistance = previewScrollPosition * itemWidth;
            
            // 执行滚动
            photoPreview.scrollTo({
                left: scrollDistance,
                behavior: 'smooth'
            });
            
            // 更新导航按钮状态
            updatePreviewNavButtons();
        }

        // 更新导航按钮状态
        function updatePreviewNavButtons() {
            const prevBtn = document.querySelector('.preview-prev-btn');
            const nextBtn = document.querySelector('.preview-next-btn');
            const previewItems = document.getElementById('photoPreview').querySelectorAll('.preview-item');
            
            // 显示/隐藏导航按钮
            if (previewItems.length <= PREVIEWS_VISIBLE) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                
                // 更新按钮状态
                prevBtn.disabled = previewScrollPosition === 0;
                nextBtn.disabled = previewScrollPosition >= previewItems.length - PREVIEWS_VISIBLE;
                
                // 添加/移除禁用样式
                if (prevBtn.disabled) {
                    prevBtn.classList.add('disabled');
                } else {
                    prevBtn.classList.remove('disabled');
                }
                
                if (nextBtn.disabled) {
                    nextBtn.classList.add('disabled');
                } else {
                    nextBtn.classList.remove('disabled');
                }
            }
        }

        // 确保当前选中的预览图在可视区域内
        function ensureActivePreviewVisible() {
            const photoPreview = document.getElementById('photoPreview');
            const activePreview = photoPreview.querySelector('.preview-item.active');
            const previewItems = photoPreview.querySelectorAll('.preview-item');
            
            if (!activePreview || previewItems.length <= PREVIEWS_VISIBLE) return;
            
            const activeIndex = parseInt(activePreview.dataset.index);
            
            // 如果当前选中的预览图不在可视区域内，调整滚动位置
            if (activeIndex < previewScrollPosition || activeIndex >= previewScrollPosition + PREVIEWS_VISIBLE) {
                previewScrollPosition = Math.max(0, Math.min(
                    previewItems.length - PREVIEWS_VISIBLE,
                    activeIndex - Math.floor(PREVIEWS_VISIBLE / 2)
                ));
                
                const itemWidth = previewItems[0].offsetWidth + parseInt(getComputedStyle(photoPreview).gap);
                const scrollDistance = previewScrollPosition * itemWidth;
                
                photoPreview.scrollTo({
                    left: scrollDistance,
                    behavior: 'smooth'
                });
                
                // 更新导航按钮状态
                updatePreviewNavButtons();
            }
        }

        // 导航到指定照片时更新预览栏
        function navigateToPhoto(index) {
            if (index < 0 || index >= currentViewerMarkers.length) return;
            
            currentPhotoIndex = index;
            updatePhotoDisplay();
            
            // 更新预览项激活状态
            const previewItems = document.getElementById('photoPreview').querySelectorAll('.preview-item');
            previewItems.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 更新总照片数量显示
            const totalCount = document.querySelector('.total-photo-count');
            if (totalCount) {
                totalCount.textContent = `${currentPhotoIndex + 1}/${currentViewerMarkers.length}`;
            }
            
            // 确保当前选中的预览图在可视区域内
            ensureActivePreviewVisible();
        }
        
        // 导航照片（向前或向后）
        function navigatePhoto(direction) {
            let newIndex = currentPhotoIndex + direction;
            
            // 循环导航
            if (newIndex < 0) {
                newIndex = currentViewerMarkers.length - 1;
            } else if (newIndex >= currentViewerMarkers.length) {
                newIndex = 0;
            }
            
            navigateToPhoto(newIndex);
        }
        
        // 关闭照片查看器
        function closePhotoViewer() {
            const photoViewer = document.getElementById('photoViewer');
            photoViewer.classList.remove('active');
            children = document.getElementById('ppc').childNodes;
            for (var i = children.length - 1; i >= 0; i--) {
                if (children[i].nodeType === 1 && children[i].classList.contains('total-photo-count')) {
                    children[i].remove();
                }
            }
            // 显示导航栏
            document.querySelector('.navbar').classList.remove('navbar-hidden');
            // 显示地图缩放控件
            const zoomControl = document.querySelector('.leaflet-control-zoom');
            if (zoomControl) {
                zoomControl.classList.remove('leaflet-control-zoom-hidden');
            }
            
            currentViewerMarkers = [];
            currentPhotoIndex = 0;
        }
        
        // 切换详情面板
        function toggleDetails() {
            const detailsPanel = document.getElementById('photoDetails');
            if (isDetailsOpen) {
                detailsPanel.classList.remove('open');
                document.getElementById('cbt').onclick = function(){closePhotoViewer();};
            } else {
                detailsPanel.classList.add('open');
                document.getElementById('cbt').onclick = function(){closeDetails();};
            }
            isDetailsOpen = !isDetailsOpen;
        }
        
        // 关闭详情面板
        function closeDetails() {
            const detailsPanel = document.getElementById('photoDetails');
            detailsPanel.classList.remove('open');
            document.getElementById('cbt').onclick = function(){closePhotoViewer();};
            isDetailsOpen = false;
        }
        
        // 下载当前照片
        function downloadCurrentPhoto() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const link = document.createElement('a');
            link.href = SERVER_HOST + marker.photoData.raw;
            link.download = SERVER_HOST + marker.photoData.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 切换全屏模式
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`全屏请求错误: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // 显示密码模态框
        function showPasswordModal() {
            passwordModal.show();
        };

        // 显示数据更新提示
        function showUpdateNotification() {
            const updateNotification = document.getElementById('updateNotification');
            const updateTimeElement = document.getElementById('updateTime');
            
            // 获取当前时间
            const updateTime = decryptedData.exportDate;
            
            // 设置更新时间
            updateTimeElement.textContent = updateTime;
            
            // 显示弹窗
            updateNotification.classList.add('show');
            
            // 数秒后隐藏弹窗
            setTimeout(() => {
                hideUpdateNotification();
            }, 5000);
        }

        // 隐藏数据更新提示
        function hideUpdateNotification() {
            const updateNotification = document.getElementById('updateNotification');
            updateNotification.classList.remove('show');
        }

        // 页面加载完成后初始化地图
        window.onload = function() {
            // 初始化地图
            initMap();

            // 初始化地图源事件
            initMapSourceEvents();

            // 确保没有模态框背景残留（添加这行代码）
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

            // 初始化模态框
            passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'), {
                backdrop: 'static', // 禁用点击背景关闭
                keyboard: false     // 禁用ESC键关闭
            });

            // 添加模态框事件监听器
            document.getElementById('passwordModal').addEventListener('shown.bs.modal', function() {
                isModalOpen = true;
                // 模态框显示后自动聚焦到密码输入框
                document.getElementById('viewerPassword').focus();
            });
            document.getElementById('passwordModal').addEventListener('hidden.bs.modal', function() {
                isModalOpen = false;
            });

            // 监听密码输入框的回车键
            document.getElementById('viewerPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    decryptData();
                }
            });
            // 检查是否需要解密
            if (a.encrypted) {
                // 显示密码输入框
                showPasswordModal();
            } else {
                // 直接加载照片数据
                decryptedData = a;
                loadPredefinedPhotos();
                // 显示导出时间
                setTimeout(showUpdateNotification, 500);
            }
        };


    </script>
</body>
</html>