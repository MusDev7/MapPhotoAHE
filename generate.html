<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片地图管理工具</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #map {
            position: absolute;
            top: 56px;
            bottom: 0;
            width: 100%;
            height: calc(100vh - 56px);
        }
        
        .photo-marker {
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        
        .photo-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        .photo-marker img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }
        
        .photo-cluster {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .photo-cluster:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        .cluster-photo {
            position: absolute;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }
        
        .cluster-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cluster-count {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background-color: #ff4757;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        
        .photo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .photo-viewer.active {
            opacity: 1;
            visibility: visible;
        }
        
        .photo-container {
            position: relative;
            width: 90%;
            height: 70%;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .photo-display {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .main-photo {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.25);
        }
        
        .photo-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            pointer-events: none;
        }
        
        .nav-btn {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 24px;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .nav-btn:hover {
            background-color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
            font-size: 20px;
            cursor: pointer;
            z-index: 1010;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .close-btn:hover {
            background-color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .photo-toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: transparent;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            background-color: rgba(44, 62, 80, 0.85);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }
        
        .toolbar-btn:hover {
            background-color: #34495e;
            transform: translateY(-2px);
        }
        
        .toolbar-btn.delete-btn {
            background-color: rgba(231, 76, 60, 0.85);
        }
        
        .toolbar-btn.delete-btn:hover {
            background-color: #c0392b;
        }
        
        .photo-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        
        .preview-item {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            flex-shrink: 0;
            position: relative;
        }
        
        .preview-item:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        .preview-item.active {
            opacity: 1;
            border: 2px solid #3498db;
            transform: scale(1.1);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-count-indicator {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .total-photo-count {
            margin-left: 10px;
            padding: 4px 10px;
            background-color: #2c3e50;
            color: white;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
        }
        
        .navbar {
            z-index: 1000;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* 右键菜单样式 */
        .custom-context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            padding: 5px 0;
        }
        
        .custom-context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .custom-context-menu li {
            padding: 8px 15px;
            cursor: pointer;
        }
        
        .custom-context-menu li:hover {
            background-color: #f0f0f0;
        }
        
        /* 详情面板 */
        .photo-details {
            position: absolute;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .photo-details.open {
            right: 0;
        }
        
        .photo-details h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .detail-item {
            margin-bottom: 15px;
        }
        
        .detail-item label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #7f8c8d;
        }
        
        .detail-item .value {
            color: 2c3e50;
        }
        
        /* 备注区域 */
        .note-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .note-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .note-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        /* 进度条样式 */
        .progress-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            min-width: 300px;
            text-align: center;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* 搜索标记样式 */
        .search-marker {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .photo-container {
                width: 95%;
                height: 60%;
            }
            
            .photo-details {
                width: 280px;
            }
            
            .photo-toolbar {
                flex-wrap: wrap;
            }
            
            .photo-preview {
                flex-wrap: wrap;
                max-width: 90%;
            }
            
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .navbar .btn {
                font-size: 12px;
                padding: 5px 8px;
            }
            
            #search-input {
                max-width: 150px !important;
            }
        }
        
        .navbar-hidden {
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        /* 调整Leaflet缩放控件位置 */
        .leaflet-top.leaflet-left {
            top: 80px;
        }

        /* 隐藏缩放控件的类 */
        .leaflet-control-zoom-hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        /* 导出选项样式 */
        .export-options {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            min-width: 300px;
        }
        
        .export-options h5 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .export-options .form-check {
            margin-bottom: 15px;
        }
        
        .export-options .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            position: fixed;
            top: 56px;
            right: -350px;
            width: 350px;
            height: calc(100% - 56px);
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }
        
        .sidebar.open {
            right: 0;
        }
        
        .sidebar h4 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .photo-list {
            margin-top: 20px;
        }
        
        .photo-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .photo-list-item:hover {
            background-color: #f5f5f5;
        }
        
        .photo-list-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .photo-list-info {
            flex-grow: 1;
        }
        
        .photo-list-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .photo-list-location {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .photo-list-actions {
            display: flex;
            gap: 5px;
        }
        
        .photo-list-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .photo-list-btn:hover {
            color: #3498db;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">照片地图管理工具</span>
            
            <!-- 添加搜索框 -->
            <div class="d-flex align-items-center me-3">
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control" placeholder="输入地址进行搜索..." style="max-width: 250px;">
                    <button class="btn btn-outline-primary" type="button" onclick="searchLocation()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="清除搜索标记">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="d-flex">
                <input type="file" id="photo-upload" multiple accept="image/*" style="display: none;">
                <button class="btn btn-primary me-2" onclick="document.getElementById('photo-upload').click()">
                    <i class="fas fa-plus"></i> 添加照片
                </button>
                <button class="btn btn-success me-2" onclick="showExportOptions()">
                    <i class="fas fa-download"></i> 导出数据
                </button>
                <button class="btn btn-info me-2" onclick="document.getElementById('import-file').click()">
                    <i class="fas fa-upload"></i> 导入数据
                </button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(this.files)">
                <button class="btn btn-outline-secondary me-2" onclick="toggleSidebar()">
                    <i class="fas fa-list"></i> 照片列表
                </button>
                <button class="btn btn-outline-danger" onclick="clearAllPhotos()">
                    <i class="fas fa-trash"></i> 清除全部
                </button>
            </div>
        </div>
    </nav>
    
    <!-- 地图容器 -->
    <div id="map"></div>
    
    <!-- 侧边栏 -->
    <div class="sidebar" id="sidebar">
        <h4>照片列表</h4>
        <div class="photo-list" id="photoList">
            <!-- 照片列表将通过JS动态添加 -->
        </div>
    </div>
    
    <!-- 照片查看器 -->
    <div class="photo-viewer" id="photoViewer">
        <div class="close-btn" onclick="closePhotoViewer()">
            <i class="fas fa-times"></i>
        </div>
        
        <div class="photo-container">
            <div class="photo-display">
                <img class="main-photo" id="mainPhoto" src="" alt="Photo">
            </div>
        </div>
        
        <div class="photo-controls">
            <div class="nav-btn prev-btn" onclick="navigatePhoto(-1)">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="nav-btn next-btn" onclick="navigatePhoto(1)">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
        
        <div class="photo-toolbar">
            <button class="toolbar-btn delete-btn" onclick="deleteCurrentPhoto()">
                <i class="fas fa-trash"></i> 删除
            </button>
            <button class="toolbar-btn" onclick="toggleDetails()">
                <i class="fas fa-info-circle"></i> 详情
            </button>
            <button class="toolbar-btn" onclick="downloadCurrentPhoto()">
                <i class="fas fa-download"></i> 下载
            </button>
        </div>
        
        <div class="photo-preview" id="photoPreview">
            <!-- 预览小图将通过JS动态添加 -->
        </div>
        
        <div class="photo-details" id="photoDetails">
            <h3>照片详情</h3>
            <div class="detail-item">
                <label>位置</label>
                <div class="value" id="detailLocation"></div>
            </div>
            <div class="detail-item">
                <label>尺寸</label>
                <div class="value" id="detailDimensions"></div>
            </div>
            <div class="detail-item">
                <label>文件名称</label>
                <div class="value" id="detailFilename"></div>
            </div>
            <div class="detail-item">
                <label>添加时间</label>
                <div class="value" id="detailTimestamp"></div>
            </div>
            
            <div class="note-section">
                <h4>备注</h4>
                <textarea class="note-textarea" id="noteTextarea" placeholder="添加照片备注..."></textarea>
                <button class="btn btn-primary" onclick="saveNote()">保存备注</button>
            </div>
        </div>
    </div>
    
    <!-- 进度提示框 -->
    <div class="progress-container" id="progressContainer">
        <h5 id="progressTitle">处理中</h5>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressMessage">请稍候...</p>
    </div>
    
    <!-- 右键菜单 -->
    <div id="context-menu" class="custom-context-menu">
        <ul>
            <li onclick="addPhotoAtContextMenuLocation()">在此处添加照片</li>
            <li onclick="hideContextMenu()">取消</li>
        </ul>
    </div>
    
    <!-- 导出选项 -->
    <div class="export-options" id="exportOptions">
        <h5>导出选项</h5>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeThumbs" checked>
            <label class="form-check-label" for="includeThumbs">
                包含缩略图
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeFullImages" checked>
            <label class="form-check-label" for="includeFullImages">
                包含原图（Base64编码）
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeMetadata" checked>
            <label class="form-check-label" for="includeMetadata">
                包含元数据（位置、时间等）
            </label>
        </div>
        <!-- 添加密码保护选项 -->
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="encryptData" onchange="togglePasswordField()">
            <label class="form-check-label" for="encryptData">
                密码保护
            </label>
        </div>
        <div id="passwordField" style="display: none; margin-top: 10px;">
            <label for="exportPassword">密码</label>
            <input type="password" class="form-control" id="exportPassword" placeholder="输入加密密码">
            <small class="form-text text-muted">请牢记密码，丢失后将无法恢复数据</small>
        </div>

        <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="hideExportOptions()">取消</button>
            <button type="button" class="btn btn-primary" onclick="exportData()">导出</button>
        </div>
    </div>

    <!-- 必要的JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // 全局变量
        let map;
        let photoMarkers = [];
        let photoClusters = {};
        let currentPhoto = null;
        let pendingPhotos = [];
        let contextMenuLocation = null;
        let searchMarker = null;
        let amapKey = 'fe4d710bb0b7ecb71c69ca60b9963e6d'; // 高德地图API密钥
        
        // 照片查看器相关变量
        let currentViewerMarkers = [];
        let currentPhotoIndex = 0;
        let isSidebarOpen = false;
        let isDetailsOpen = false;

        // 初始化地图
        function initMap() {
            // 创建地图实例，设置中心点和缩放级别
            map = L.map('map').setView([35.8617, 104.1954], 5); // 中国中心点
            
            // 使用高德地图瓦片
            L.tileLayer('https://webrd04.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
                maxZoom: 19
            }).addTo(map);
            
            // 监听搜索框的回车键
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            // 添加点击地图选择位置的功能
            map.on('click', function(e) {
                if (pendingPhotos.length > 0) {
                    // 如果有待处理的照片，使用点击的位置
                    pendingPhotos.forEach(file => {
                        addPhotoToMap(file, e.latlng.lat, e.latlng.lng);
                    });
                    
                    // 清空待处理列表
                    pendingPhotos = [];
                }
                
                // 点击地图时隐藏右键菜单
                hideContextMenu();
            });
            
            // 监听文件选择事件
            document.getElementById('photo-upload').addEventListener('change', handlePhotoUpload);
            
            // 监听右键点击事件
            map.on('contextmenu', function(e) {
                // 阻止默认的右键菜单
                e.originalEvent.preventDefault();
                
                // 显示自定义右键菜单
                showContextMenu(e.originalEvent.clientX, e.originalEvent.clientY, e.latlng);
            });
            
            // 点击页面其他区域时隐藏右键菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-context-menu')) {
                    hideContextMenu();
                }
            });
            
            // 监听ESC键关闭照片查看器
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePhotoViewer();
                } else if (e.key === 'ArrowLeft') {
                    navigatePhoto(-1);
                } else if (e.key === 'ArrowRight') {
                    navigatePhoto(1);
                }
            });
            
            // 尝试加载本地存储的照片数据
            loadLocalData();
        }
        
        // 加载本地存储的数据
        function loadLocalData() {
            const savedData = localStorage.getItem('photoMapData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    data.photos.forEach(photo => {
                        // 将Base64数据转换为Blob
                        if (photo.fullDataUrl && photo.fullDataUrl.startsWith('data:')) {
                            const byteString = atob(photo.fullDataUrl.split(',')[1]);
                            const mimeString = photo.fullDataUrl.split(',')[0].split(':')[1].split(';')[0];
                            const ab = new ArrayBuffer(byteString.length);
                            const ia = new Uint8Array(ab);
                            for (let i = 0; i < byteString.length; i++) {
                                ia[i] = byteString.charCodeAt(i);
                            }
                            const blob = new Blob([ab], {type: mimeString});
                            const file = new File([blob], photo.filename, {type: mimeString});
                            
                            addPhotoToMap(file, photo.lat, photo.lng, photo);
                        }
                    });
                } catch (error) {
                    console.error('加载本地数据失败:', error);
                }
            }
        }
        
        // 保存数据到本地存储
        function saveLocalData() {
            const photoData = photoMarkers.map(marker => {
                return {
                    thumbDataUrl: marker.photoData.dataUrl,
                    fullDataUrl: marker.photoData.fullDataUrl,
                    lat: marker.photoData.lat,
                    lng: marker.photoData.lng,
                    filename: marker.photoData.file.name,
                    timestamp: marker.photoData.timestamp,
                    note: marker.photoData.note || ''
                };
            });
            
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                photos: photoData
            };
            
            localStorage.setItem('photoMapData', JSON.stringify(data));
        }
        
        // 搜索位置函数
        function searchLocation() {
            const address = document.getElementById('search-input').value.trim();
            if (!address) {
                alert('请输入要搜索的地址');
                return;
            }
            
            showProgress('地址搜索', '正在搜索地址...', 0);
            
            // 使用高德地图地理编码API
            const encodedAddress = encodeURIComponent(address);
            const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodedAddress}&output=JSON&key=${amapKey}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location;
                        const [lng, lat] = location.split(',').map(Number);
                        
                        // 移动到搜索到的位置
                        map.setView([lat, lng], 15);
                        
                        // 清除之前的搜索标记
                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }
                        
                        // 添加新标记
                        searchMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'search-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 30px;"></i>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(map);
                        
                        // 添加弹出窗口
                        searchMarker.bindPopup(`
                            <div style="text-align: center;">
                                <strong>${data.geocodes[0].formatted_address}</strong><br>
                                <small>${data.geocodes[0].province} ${data.geocodes[0].city} ${data.geocodes[0].district}</small>
                            </div>
                        `).openPopup();
                        
                        hideProgress();
                    } else {
                        hideProgress();
                        alert('未找到该地址，请尝试更具体的地址描述');
                    }
                })
                .catch(error => {
                    hideProgress();
                    console.error('搜索失败:', error);
                    alert('搜索失败，请检查网络连接或稍后重试');
                });
        }
        
        // 清除搜索标记
        function clearSearch() {
            if (searchMarker) {
                map.removeLayer(searchMarker);
                searchMarker = null;
            }
            document.getElementById('search-input').value = '';
        }
        
        // 显示进度提示
        function showProgress(title, message, percent) {
            const container = document.getElementById('progressContainer');
            const titleEl = document.getElementById('progressTitle');
            const messageEl = document.getElementById('progressMessage');
            const fillEl = document.getElementById('progressFill');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            fillEl.style.width = percent + '%';
            container.style.display = 'block';
        }
        
        // 隐藏进度提示
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        // 显示导出选项
        function showExportOptions() {
            document.getElementById('exportOptions').style.display = 'block';
        }
        
        // 隐藏导出选项
        function hideExportOptions() {
            document.getElementById('exportOptions').style.display = 'none';
        }
        
        // 导出数据
        function exportData() {
            hideExportOptions();
            
            const includeThumbs = document.getElementById('includeThumbs').checked;
            const includeFullImages = document.getElementById('includeFullImages').checked;
            const includeMetadata = document.getElementById('includeMetadata').checked;
            const encryptData = document.getElementById('encryptData').checked;
            const password = document.getElementById('exportPassword').value;
            
            if (encryptData && !password) {
                alert('请设置加密密码');
                showExportOptions();
                return;
            }
            
            showProgress('导出数据', '准备导出数据...', 0);
            
            // 收集照片数据
            const photoData = photoMarkers.map(marker => {
                const data = {};
                
                if (includeThumbs) {
                    data.thumbDataUrl = marker.photoData.dataUrl;
                    data.thumbWidth = marker.photoData.thumbWidth;
                    data.thumbHeight = marker.photoData.thumbHeight;
                }
                
                if (includeFullImages) {
                    // 读取原图为Base64
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function() {
                            if (includeFullImages) {
                                data.fullDataUrl = reader.result;
                            }
                            
                            if (includeMetadata) {
                                data.lat = marker.photoData.lat;
                                data.lng = marker.photoData.lng;
                                data.filename = marker.photoData.file.name;
                                data.timestamp = marker.photoData.timestamp;
                                data.note = marker.photoData.note || '';
                                data.width = marker.photoData.width;
                                data.height = marker.photoData.height;
                            }
                            
                            resolve(data);
                        };
                        reader.readAsDataURL(marker.photoData.file);
                    });
                } else {
                    if (includeMetadata) {
                        data.lat = marker.photoData.lat;
                        data.lng = marker.photoData.lng;
                        data.filename = marker.photoData.file.name;
                        data.timestamp = marker.photoData.timestamp;
                        data.note = marker.photoData.note || '';
                        data.width = marker.photoData.width;
                        data.height = marker.photoData.height;
                    }
                    
                    return Promise.resolve(data);
                }
            });
            
            Promise.all(photoData).then(photos => {
                showProgress('导出数据', '生成导出文件...', 90);
                
                // 创建导出数据对象
                const exportData = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    encrypted: encryptData,
                    photos: photos
                };
                
                // 转换为JSON字符串
                let jsonData = JSON.stringify(exportData);
                
                // 如果需要加密
                if (encryptData) {
                    showProgress('导出数据', '加密数据...', 95);
                    try {
                        // 使用CryptoJS进行AES加密
                        const salt = CryptoJS.lib.WordArray.random(128/8);
                        const key = CryptoJS.PBKDF2(password, salt, {
                            keySize: 256/32,
                            iterations: 1000
                        });
                        const iv = CryptoJS.lib.WordArray.random(128/8);
                        
                        const encrypted = CryptoJS.AES.encrypt(jsonData, key, {
                            iv: iv,
                            padding: CryptoJS.pad.Pkcs7,
                            mode: CryptoJS.mode.CBC
                        });
                        
                        // 组合盐、IV和加密数据
                        const encryptedData = salt.toString() + iv.toString() + encrypted.toString();
                        jsonData = JSON.stringify({
                            encrypted: true,
                            data: encryptedData
                        });
                    } catch (error) {
                        hideProgress();
                        alert('加密失败: ' + error.message);
                        return;
                    }
                }
                
                // 创建下载链接
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `photo-map-export-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideProgress();
            });
        }
        
        // 导入数据
        function importData(files) {
            if (!files || files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let data = JSON.parse(e.target.result);
                    
                    // 检查是否是加密数据
                    if (data.encrypted) {
                        // 弹出密码输入框
                        const password = prompt('此文件已加密，请输入密码');
                        if (!password) {
                            alert('密码不能为空');
                            return;
                        }
                        
                        try {
                            // 使用CryptoJS进行AES解密
                            const bytes = CryptoJS.AES.decrypt(data.data, password);
                            const decryptedData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                            data = decryptedData;
                        } catch (error) {
                            alert('解密失败，密码错误或文件已损坏');
                            return;
                        }
                    }
                    
                    // 验证数据格式
                    if (!data.photos) {
                        throw new Error('无效的数据文件格式');
                    }
                    
                    showProgress('导入数据', '准备导入数据...', 0);
                    
                    // 清除现有数据
                    clearAllPhotos();
                    
                    // 恢复照片
                    showProgress('导入数据', '恢复照片数据...', 50);
                    restorePhotos(data.photos, data.photos.length);
                    
                } catch (error) {
                    console.error('导入数据失败:', error);
                    alert('导入数据失败: ' + error.message);
                    hideProgress();
                }
            };
            
            reader.readAsText(file);
        }
        
        // 恢复照片数据
        function restorePhotos(photos, total) {
            if (photos.length === 0) {
                hideProgress();
                // 更新照片列表
                updatePhotoList();
                return;
            }
            
            const photo = photos.shift();
            const processed = total - photos.length;
            const percent = 50 + (processed / total) * 50;
            
            showProgress('导入数据', `恢复照片 (${processed}/${total})...`, percent);
            
            // 处理Base64数据
            if (photo.fullDataUrl && photo.fullDataUrl.startsWith('data:')) {
                const byteString = atob(photo.fullDataUrl.split(',')[1]);
                const mimeString = photo.fullDataUrl.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([ab], {type: mimeString});
                const file = new File([blob], photo.filename, {type: mimeString});
                
                // 添加照片到地图，传递尺寸信息
                addPhotoToMap(file, photo.lat, photo.lng, {
                    ...photo,
                    width: photo.width || 0,
                    height: photo.height || 0,
                    thumbWidth: photo.thumbWidth || 60,
                    thumbHeight: photo.thumbHeight || 60
                });
            }
            
            // 处理下一张照片
            setTimeout(() => restorePhotos(photos, total), 100);
        }
        
        // 添加照片到地图
        function addPhotoToMap(file, lat, lng, photoData = null) {
            // 创建照片缩略图
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // 创建缩略图
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 100; // 缩略图大小
                    
                    // 计算缩略图尺寸，保持宽高比
                    let width = size;
                    let height = size;
                    
                    if (img.width > img.height) {
                        height = (size * img.height) / img.width;
                    } else {
                        width = (size * img.width) / img.height;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    
                    // 创建自定义标记
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'photo-marker fade-in',
                            html: `<img src="${dataUrl}" alt="Photo">`,
                            iconSize: [width, height],
                            iconAnchor: [width/2, height/2]
                        })
                    });
                    
                    // 存储照片数据
                    marker.photoData = {
                        file: file,
                        dataUrl: dataUrl,
                        fullDataUrl: e.target.result,
                        lat: lat,
                        lng: lng,
                        width: img.width,
                        height: img.height,
                        thumbWidth: width,
                        thumbHeight: height,
                        timestamp: photoData ? photoData.timestamp : new Date().toLocaleString(),
                        note: photoData ? (photoData.note || '') : ''
                    };
                    
                    // 添加点击事件
                    marker.on('click', function() {
                        showPhotoViewer([marker], 0);
                    });
                    
                    // 添加到地图
                    marker.addTo(map);
                    photoMarkers.push(marker);
                    
                    // 更新照片聚类
                    updatePhotoClusters();
                    
                    // 更新照片列表
                    updatePhotoList();
                    
                    // 保存到本地存储
                    saveLocalData();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // 显示右键菜单
        function showContextMenu(x, y, latlng) {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            
            // 保存点击位置
            contextMenuLocation = latlng;
        }
        
        // 隐藏右键菜单
        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'none';
            contextMenuLocation = null;
        }
        
        // 在右键菜单位置添加照片
        function addPhotoAtContextMenuLocation() {
            if (!contextMenuLocation) return;
            
            // 触发文件选择
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.multiple = true;
            
            fileInput.onchange = function(e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.match('image.*')) continue;
                    
                    // 直接在地图点击位置添加照片，忽略EXIF信息
                    addPhotoToMap(file, contextMenuLocation.lat, contextMenuLocation.lng);
                }
                
                // 隐藏右键菜单
                hideContextMenu();
            };
            
            fileInput.click();
        }
        
        // 处理照片上传
        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                // 读取EXIF数据获取位置信息
                EXIF.getData(file, function() {
                    const lat = EXIF.getTag(this, 'GPSLatitude');
                    const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                    const lng = EXIF.getTag(this, 'GPSLongitude');
                    const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');
                    
                    let latitude, longitude;
                    
                    if (lat && lng) {
                        // 转换EXIF坐标格式为十进制
                        latitude = convertDMSToDD(lat[0], lat[1], lat[2], latRef);
                        longitude = convertDMSToDD(lng[0], lng[1], lng[2], lngRef);
                        
                        // 添加照片到地图
                        addPhotoToMap(file, latitude, longitude);
                    } else {
                        // 没有位置信息，添加到待处理列表
                        pendingPhotos.push(file);
                        alert(`照片 "${file.name}" 没有地理位置信息，请点击地图选择位置`);
                    }
                });
            }
            
            // 清空文件选择器，允许重复选择相同文件
            event.target.value = '';
        }
        
        // 更新照片聚类
        function updatePhotoClusters() {
            // 清空现有聚类
            for (const key in photoClusters) {
                map.removeLayer(photoClusters[key]);
            }
            photoClusters = {};
            
            // 按位置分组照片
            const groupedMarkers = {};
            const clusterDistance = 0.01; // 聚类距离（经纬度）
            
            photoMarkers.forEach(marker => {
                const lat = marker.getLatLng().lat;
                const lng = marker.getLatLng().lng;
                
                // 查找附近的现有聚类
                let foundCluster = false;
                for (const key in groupedMarkers) {
                    const [clusterLat, clusterLng] = key.split(',').map(Number);
                    const distance = Math.sqrt(Math.pow(lat - clusterLat, 2) + Math.pow(lng - clusterLng, 2));
                    
                    if (distance < clusterDistance) {
                        groupedMarkers[key].push(marker);
                        foundCluster = true;
                        break;
                    }
                }
                
                // 如果没有找到附近的聚类，创建新聚类
                if (!foundCluster) {
                    const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
                    groupedMarkers[key] = [marker];
                }
            });
            
            // 为每个组创建聚类标记
            for (const key in groupedMarkers) {
                const markers = groupedMarkers[key];
                
                if (markers.length > 1) {
                    // 创建聚类标记 - 显示叠加的照片
                    const centerLat = markers.reduce((sum, m) => sum + m.getLatLng().lat, 0) / markers.length;
                    const centerLng = markers.reduce((sum, m) => sum + m.getLatLng().lng, 0) / markers.length;
                    
                    // 创建叠加照片的HTML
                    let clusterHtml = '<div class="photo-cluster">';
                    
                    // 最多显示4张照片的叠加
                    const maxPhotosToShow = Math.min(4, markers.length);
                    for (let i = 0; i < maxPhotosToShow; i++) {
                        const rotation = (i - (maxPhotosToShow-1)/2) * 10; // 轻微旋转每张照片
                        const offsetX = (i - (maxPhotosToShow-1)/2) * 5; // X轴偏移
                        const offsetY = (i - (maxPhotosToShow-1)/2) * 5; // Y轴偏移
                        
                        // 获取照片的实际宽高比
                        const thumbWidth = markers[i].photoData.thumbWidth;
                        const thumbHeight = markers[i].photoData.thumbHeight;
                        const aspectRatio = thumbWidth / thumbHeight;
                        
                        // 根据宽高比设置显示尺寸
                        let displayWidth, displayHeight;
                        if (aspectRatio > 1) {
                            // 横版照片
                            displayWidth = i === 0 ? 60 : 50;
                            displayHeight = displayWidth / aspectRatio;
                        } else {
                            // 竖版照片
                            displayHeight = i === 0 ? 60 : 50;
                            displayWidth = displayHeight * aspectRatio;
                        }
                        
                        clusterHtml += `
                            <div class="cluster-photo" style="
                                transform: rotate(${rotation}deg);
                                z-index: ${maxPhotosToShow - i};
                                left: ${offsetX}px;
                                top: ${offsetY}px;
                                width: ${displayWidth}px;
                                height: ${displayHeight}px;
                            ">
                                <img src="${markers[i].photoData.dataUrl}" alt="Photo">
                            </div>
                        `;
                    }
                    
                    // 添加照片数量指示器（在下方显示）
                    if (markers.length > maxPhotosToShow) {
                        clusterHtml += `<div class="cluster-count">+${markers.length - maxPhotosToShow + 1}</div>`;
                    }
                    
                    clusterHtml += '</div>';
                    
                    const cluster = L.marker([centerLat, centerLng], {
                        icon: L.divIcon({
                            className: 'fade-in',
                            html: clusterHtml,
                            iconSize: [80, 80],
                            iconAnchor: [40, 40]
                        })
                    });
                    
                    // 添加点击事件
                    cluster.on('click', function() {
                        showPhotoViewer(markers, 0);
                    });
                    
                    // 添加到地图和聚类对象
                    cluster.addTo(map);
                    photoClusters[key] = cluster;
                    
                    // 隐藏单个标记
                    markers.forEach(marker => {
                        map.removeLayer(marker);
                    });
                } else {
                    // 单个照片，确保显示在地图上
                    if (!map.hasLayer(markers[0])) {
                        markers[0].addTo(map);
                    }
                }
            }
        }
        
        // 更新照片列表
        function updatePhotoList() {
            const photoList = document.getElementById('photoList');
            photoList.innerHTML = '';
            
            if (photoMarkers.length === 0) {
                photoList.innerHTML = '<p class="text-center text-muted">暂无照片</p>';
                return;
            }
            
            photoMarkers.forEach((marker, index) => {
                const item = document.createElement('div');
                item.className = 'photo-list-item';
                
                item.innerHTML = `
                    <img src="${marker.photoData.dataUrl}" alt="${marker.photoData.file.name}">
                    <div class="photo-list-info">
                        <div class="photo-list-name">${marker.photoData.file.name}</div>
                        <div class="photo-list-location">${marker.photoData.lat.toFixed(6)}, ${marker.photoData.lng.toFixed(6)}</div>
                    </div>
                    <div class="photo-list-actions">
                        <button class="photo-list-btn" onclick="focusOnPhoto(${index})" title="定位">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                        <button class="photo-list-btn" onclick="showPhotoViewer([photoMarkers[${index}]], 0)" title="查看">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="photo-list-btn" onclick="deletePhoto(${index})" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                photoList.appendChild(item);
            });
        }
        
        // 定位到照片
        function focusOnPhoto(index) {
            if (index < 0 || index >= photoMarkers.length) return;
            
            const marker = photoMarkers[index];
            map.setView(marker.getLatLng(), 15);
            
            // 如果照片在聚类中，显示查看器
            if (map.hasLayer(marker)) {
                marker.fire('click');
            } else {
                // 查找包含此照片的聚类
                for (const key in photoClusters) {
                    const cluster = photoClusters[key];
                    if (cluster.getLatLng().equals(marker.getLatLng())) {
                        cluster.fire('click');
                        break;
                    }
                }
            }
        }
        
        // 删除照片
        function deletePhoto(index) {
            if (index < 0 || index >= photoMarkers.length) return;
            
            const marker = photoMarkers[index];
            
            // 从地图移除标记
            map.removeLayer(marker);
            
            // 从数组中移除
            photoMarkers.splice(index, 1);
            
            // 更新照片聚类
            updatePhotoClusters();
            
            // 更新照片列表
            updatePhotoList();
            
            // 保存到本地存储
            saveLocalData();
        }
        
        // 显示照片查看器
        function showPhotoViewer(markers, index) {
            currentViewerMarkers = markers;
            currentPhotoIndex = index;
            
            // 隐藏导航栏
            document.querySelector('.navbar').classList.add('navbar-hidden');
            
            // 隐藏地图缩放控件
            const zoomControl = document.querySelector('.leaflet-control-zoom');
            if (zoomControl) {
                zoomControl.classList.add('leaflet-control-zoom-hidden');
            }
                
            // 显示照片查看器
            const photoViewer = document.getElementById('photoViewer');
            photoViewer.classList.add('active');
            
            // 更新照片显示
            updatePhotoDisplay();
            
            // 更新预览小图
            updatePhotoPreviews();
            
            // 关闭详情面板（如果打开）
            closeDetails();
        }
        
        // 更新照片显示
        function updatePhotoDisplay() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const mainPhoto = document.getElementById('mainPhoto');
            
            // 创建照片URL
            const photoUrl = URL.createObjectURL(marker.photoData.file);
            mainPhoto.src = photoUrl;
            
            // 更新详情信息
            updatePhotoDetails();
            
            // 更新备注
            document.getElementById('noteTextarea').value = marker.photoData.note || '';
        }
        
        // 更新照片详情
        function updatePhotoDetails() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            
            document.getElementById('detailLocation').textContent = 
                `${marker.photoData.lat.toFixed(6)}, ${marker.photoData.lng.toFixed(6)}`;
            
            document.getElementById('detailDimensions').textContent = 
                `${marker.photoData.width} × ${marker.photoData.height}`;
            
            document.getElementById('detailFilename').textContent = 
                marker.photoData.file.name;
            
            document.getElementById('detailTimestamp').textContent = 
                marker.photoData.timestamp;
        }
        
        // 更新照片预览
        function updatePhotoPreviews() {
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = '';
            
            // 最多显示8张预览图
            const maxPreviews = Math.min(8, currentViewerMarkers.length);
            
            for (let i = 0; i < maxPreviews; i++) {
                const marker = currentViewerMarkers[i];
                const previewItem = document.createElement('div');
                previewItem.className = `preview-item ${i === currentPhotoIndex ? 'active' : ''}`;
                
                const img = document.createElement('img');
                img.src = marker.photoData.dataUrl;
                img.alt = `预览图 ${i + 1}`;
                
                // 如果照片数量超过4张，添加数量指示器
                if (i === maxPreviews - 1 && currentViewerMarkers.length > maxPreviews) {
                    const countIndicator = document.createElement('div');
                    countIndicator.className = 'photo-count-indicator';
                    countIndicator.textContent = `+${currentViewerMarkers.length - maxPreviews + 1}`;
                    previewItem.appendChild(countIndicator);
                }
                
                previewItem.appendChild(img);
                previewItem.addEventListener('click', () => {
                    navigateToPhoto(i);
                });
                
                photoPreview.appendChild(previewItem);
            }
            
            // 添加总照片数量显示
            if (currentViewerMarkers.length > 4) {
                const totalCount = document.createElement('div');
                totalCount.className = 'total-photo-count';
                totalCount.textContent = `${currentPhotoIndex + 1}/${currentViewerMarkers.length}`;
                photoPreview.appendChild(totalCount);
            }
        }
        
        // 导航到指定照片
        function navigateToPhoto(index) {
            if (index < 0 || index >= currentViewerMarkers.length) return;
            
            currentPhotoIndex = index;
            updatePhotoDisplay();
            updatePhotoPreviews();
        }
        
        // 导航照片（向前或向后）
        function navigatePhoto(direction) {
            let newIndex = currentPhotoIndex + direction;
            
            // 循环导航
            if (newIndex < 0) {
                newIndex = currentViewerMarkers.length - 1;
            } else if (newIndex >= currentViewerMarkers.length) {
                newIndex = 0;
            }
            
            navigateToPhoto(newIndex);
        }
        
        // 关闭照片查看器
        function closePhotoViewer() {
            const photoViewer = document.getElementById('photoViewer');
            photoViewer.classList.remove('active');
            
            // 显示导航栏
            document.querySelector('.navbar').classList.remove('navbar-hidden');
            // 显示地图缩放控件
            const zoomControl = document.querySelector('.leaflet-control-zoom');
            if (zoomControl) {
                zoomControl.classList.remove('leaflet-control-zoom-hidden');
            }
            
            // 释放URL对象
            currentViewerMarkers.forEach(marker => {
                if (marker.photoData.file) {
                    URL.revokeObjectURL(marker.photoData.file);
                }
            });
            
            currentViewerMarkers = [];
            currentPhotoIndex = 0;
        }
        
        // 删除当前照片
        function deleteCurrentPhoto() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const markerIndex = photoMarkers.indexOf(marker);
            
            if (markerIndex >= 0) {
                // 从地图移除标记
                map.removeLayer(marker);
                
                // 从数组中移除
                photoMarkers.splice(markerIndex, 1);
                
                // 从当前查看器中移除
                currentViewerMarkers.splice(currentPhotoIndex, 1);
                
                // 如果还有照片，显示下一张或前一张
                if (currentViewerMarkers.length > 0) {
                    if (currentPhotoIndex >= currentViewerMarkers.length) {
                        currentPhotoIndex = currentViewerMarkers.length - 1;
                    }
                    updatePhotoDisplay();
                    updatePhotoPreviews();
                } else {
                    // 没有照片了，关闭查看器
                    closePhotoViewer();
                }
                
                // 更新聚类
                updatePhotoClusters();
                
                // 更新照片列表
                updatePhotoList();
                
                // 保存到本地存储
                saveLocalData();
            }
        }
        
        // 切换详情面板
        function toggleDetails() {
            const detailsPanel = document.getElementById('photoDetails');
            if (isDetailsOpen) {
                detailsPanel.classList.remove('open');
            } else {
                detailsPanel.classList.add('open');
            }
            isDetailsOpen = !isDetailsOpen;
        }
        
        // 关闭详情面板
        function closeDetails() {
            const detailsPanel = document.getElementById('photoDetails');
            detailsPanel.classList.remove('open');
            isDetailsOpen = false;
        }
        
        // 保存备注
        function saveNote() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const noteText = document.getElementById('noteTextarea').value;
            
            // 更新照片数据
            marker.photoData.note = noteText;
            
            // 保存到本地存储
            saveLocalData();
            
            // 显示保存成功提示
            alert('备注已保存');
        }
        
        // 下载当前照片
        function downloadCurrentPhoto() {
            if (currentViewerMarkers.length === 0) return;
            
            const marker = currentViewerMarkers[currentPhotoIndex];
            const link = document.createElement('a');
            link.href = URL.createObjectURL(marker.photoData.file);
            link.download = marker.photoData.file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 清除所有照片
        function clearAllPhotos() {
            if (confirm('确定要删除所有照片吗？此操作不可撤销。')) {
                // 移除所有标记
                photoMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
                
                // 移除所有聚类
                for (const key in photoClusters) {
                    map.removeLayer(photoClusters[key]);
                }
                
                // 清空数组
                photoMarkers = [];
                photoClusters = {};
                
                // 如果照片查看器是打开的，关闭它
                closePhotoViewer();
                
                // 更新照片列表
                updatePhotoList();
                
                // 清除本地存储
                localStorage.removeItem('photoMapData');
            }
        }
        
        // 切换侧边栏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.add('open');
                // 更新照片列表
                updatePhotoList();
            } else {
                sidebar.classList.remove('open');
            }
        }
        
        // 转换度分秒坐标为十进制
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = degrees + minutes / 60 + seconds / 3600;
            
            if (direction === 'S' || direction === 'W') {
                dd = dd * -1;
            }
            
            return dd;
        }

        // 切换密码字段显示
        function togglePasswordField() {
            const passwordField = document.getElementById('passwordField');
            const encryptCheckbox = document.getElementById('encryptData');
            
            if (encryptCheckbox.checked) {
                passwordField.style.display = 'block';
            } else {
                passwordField.style.display = 'none';
            }
        }
                
        // 页面加载完成后初始化地图
        window.onload = initMap;
    </script>
</body>
</html>